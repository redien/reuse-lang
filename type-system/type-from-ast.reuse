
(typ (type-annotation meta)  (TypeAnnotation type meta))

(def lookup-type-parameter (name parameters)
     (list-find-first (fn (parameter)
                          (match parameter
                                 (ConstType _ __)                  False
                                 (FnType _ __)                     False
                                 (UniversalType parameter-name)    (string-equal? name parameter-name)
                                 (ExistentialType parameter-name)  (string-equal? name parameter-name)
                                 ErrorType                         False))
                      parameters))

(def type-from-ast-type (parameters ast-type)
     (match ast-type
            (SimpleType sym)
                        (match (lookup-type-parameter (symbol-name sym) parameters)
                               (Some type)  type
                               None         (ConstType (symbol-name sym) Empty))
            (ComplexType name ast-types _)               (ConstType name (list-map (type-from-ast-type parameters) ast-types))
            (FunctionType argument-types return-type _)  (FnType (list-map (type-from-ast-type parameters) argument-types)
                                                                 (type-from-ast-type parameters return-type))))

(def type-from-constructor (return-type parameters constructor)
     (match constructor
            (SimpleConstructor sym)               (Pair (symbol-name sym) (FnType Empty return-type))
            (ComplexConstructor sym ast-types _)  (Pair (symbol-name sym) (FnType (list-map (type-from-ast-type parameters) ast-types) return-type))))

(def type-from-parameter (parameter)
     (match parameter
            (UniversalParameter sym)    (UniversalType (symbol-name sym))
            (ExistentialParameter sym)  (ExistentialType (symbol-name sym))))

(def types-from-constructors (name parameters constructors)
     (list-map (type-from-constructor (ConstType name parameters) parameters) constructors))
